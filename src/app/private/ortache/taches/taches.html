<div class="modal-container" *appHasPermission="['task.view']">
  <div class="modal-header">
    <h2>D√©tails des t√¢ches</h2>
    <button class="modal-close" (click)="onFermerModal()" mat-icon-button>
      <mat-icon>close</mat-icon>
    </button>
  </div>
  
  <div class="modal-content" *ngIf="ordreInfo">
    <!-- Informations g√©n√©rales de l'ordre -->
    <div class="info-section">
      <h3>Informations de l'ordre</h3>
      <div class="info-grid">
        <div class="info-item">
          <label>V√©hicule:</label>
          <span>{{ordreInfo.vehicule}}</span>
        </div>
        <div class="info-item">
          <label>Client:</label>
          <span>{{ordreInfo.client}}</span>
        </div>
      </div>
    </div>

    <!-- R√©sum√© des t√¢ches -->
    <div class="resume-section">
      <h3>R√©sum√© des t√¢ches</h3>
      <div class="resume-grid">
        <div class="resume-item">
          <span class="resume-label">Total t√¢ches:</span>
          <span class="resume-value">{{taches.length}}</span>
        </div>
        <div class="resume-item">
          <span class="resume-label">Termin√©es:</span>
          <span class="resume-value terminee">{{getNombreTachesParStatut('COMPLETED')}}</span>
        </div>
        <div class="resume-item">
          <span class="resume-label">En cours:</span>
          <span class="resume-value en-cours">{{getNombreTachesParStatut('IN_PROGRESS')}}</span>
        </div>
        <div class="resume-item">
          <span class="resume-label">En Pause:</span>
          <span class="resume-value en-attente">{{getNombreTachesParStatut('PAUSED')}}</span>
        </div>
        <div class="resume-item">
          <span class="resume-label">Non D√©marre:</span>
          <span class="resume-value en-attente">{{getNombreTachesParStatut('NOT_STARTED')}}</span>
        </div>
        <div class="resume-item">
          <span class="resume-label">Avancement:</span>
          <span class="resume-value">{{getPourcentageAvancement()}}%</span>
        </div>
      </div>
    </div>

    <!-- Liste d√©taill√©e des t√¢ches -->
    <div class="taches-section">
      <h3>Liste des t√¢ches ({{taches.length}})</h3>

      <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Chargement des t√¢ches...</span>
      </div>
      
      <div *ngIf="!loading && errorMessage" class="error-container">
        <span class="error-icon">‚ö†Ô∏è</span>
        {{errorMessage}}
      </div>
      
      <div *ngIf="!loading && taches.length === 0" class="no-taches">
        <div class="no-taches-icon">üìã</div>
        <h3>Aucune t√¢che assign√©e</h3>
        <p>Cet ordre de r√©paration n'a pas encore de t√¢ches assign√©es.</p>
      </div>

      <div *ngIf="!loading && taches.length > 0" class="taches-container">
        <div *ngFor="let tache of taches; let i = index" class="tache-card">
          <div class="tache-header">
            <div class="tache-numero">#{{'T' + (i + 1).toString().padStart(3, '0')}}</div>
            <div class="tache-titre">
              <span class="tache-nom">{{tache.titre}}</span>
              <div class="tache-statut-container">
                <span class="tache-statut" [ngClass]="'statut-' + getStatutClass(tache.statut)">
                  <span class="statut-icon">{{getStatutIcon(tache.statut)}}</span>
                  {{tache.statut}}
                </span>
              </div>
            </div>
            <!-- Bouton pour afficher la timeline -->
            <div class="tache-actions" *ngIf="canShowTimeline(tache)">
              <button 
                class="btn-timeline" 
                (click)="loadTacheTimeline(tache.id)"
                [disabled]="loadingHistory"
                title="Voir l'historique de la t√¢che">
                <mat-icon>history</mat-icon>
                Timeline
              </button>
            </div>
          </div>
          
          <div class="tache-body" *ngIf="tache.details">
            <div class="tache-description">
              <span class="description-icon">üìù</span>
              {{tache.details}}
            </div>
          </div>

          <div class="tache-footer" *ngIf="tache.techniciens && tache.techniciens.length > 0">
            <div class="techniciens-section">
              <span class="techniciens-label">Techniciens assign√©s :</span>
              <div class="techniciens-list">
                <div *ngFor="let technicien of tache.techniciens" class="technicien-badge">
                  <span class="technicien-icon">üë®‚Äçüîß</span>
                  {{ technicien.lastName }} {{ technicien.firstName }}
                  <span *ngIf="technicien.badgeId" class="badge-id">({{ technicien.badgeId }})</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Timeline -->
  <div class="timeline-overlay" *ngIf="showTimeline" (click)="closeTimeline()">
    <div class="timeline-modal" (click)="$event.stopPropagation()">
      <div class="timeline-header">
        <h3>
          <mat-icon>timeline</mat-icon>
          Historique de la t√¢che
        </h3>
        <button class="close-timeline" (click)="closeTimeline()" mat-icon-button>
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="timeline-content">
        <div *ngIf="loadingHistory" class="timeline-loading">
          <mat-spinner diameter="30"></mat-spinner>
          <span>Chargement de l'historique...</span>
        </div>

        <div *ngIf="!loadingHistory && tacheHistory.length === 0" class="no-history">
          <mat-icon>info</mat-icon>
          <p>Aucun historique trouv√© pour cette t√¢che</p>
        </div>

        <div *ngIf="!loadingHistory && tacheHistory.length > 0" class="timeline-list">
          <div *ngFor="let entry of tacheHistory; let isLast = last" 
               class="timeline-entry" 
               [ngClass]="getTimelineClass(entry.rawType)">
            
            <div class="timeline-marker">
              <span class="timeline-icon">{{getTimelineIcon(entry.rawType)}}</span>
            </div>
            
            <div class="timeline-content-item">
              <div class="timeline-header-item">
                <span class="timeline-type">{{entry.type}}</span>
                <span class="timeline-time">{{entry.heure}} - {{entry.dateFormatted}}</span>
              </div>
              
              <div class="timeline-details">
                <div class="timeline-task">
                  <mat-icon>assignment</mat-icon>
                  {{entry.tacheNom}}
                </div>
                <div class="timeline-tech">
                  <mat-icon>person</mat-icon>
                  {{entry.technicienNom}}
                </div>
              </div>
            </div>
            
            <!-- Ligne de connexion vers l'√©l√©ment suivant -->
            <div *ngIf="!isLast" class="timeline-connector"></div>
          </div>
        </div>
      </div>

      <div class="timeline-footer">
        <button class="btn btn-secondary" (click)="closeTimeline()">Fermer</button>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn btn-secondary" (click)="onFermerModal()">Fermer</button>
  </div>
</div>